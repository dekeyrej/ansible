---
- name: Provision Proxmox VM hosts for Bombadil
  hosts: iluvatar   # executed on ManwÃ«
  tags: provision
  vars:
    host_group: sidequest
  roles:
    - role: known-hosts-clear
    - role: proxmox-provision
    
# wait for the VM to settle...
- name: Wait for VM to become reachable
  hosts: bombadil
  tags: provision
  gather_facts: no
  tasks:
    - name: Wait for SSH to come up
      ansible.builtin.wait_for_connection:
        timeout: 300  # Adjust as needed
        delay: 5      # Initial delay before polling
        sleep: 5      # Time between retries

- name: Setup Bombadil - Part 1 (root stuff)
  hosts: sidequest
  tags: setup1
  become: yes
  vars:
    # ca_key_name: ca.key
    # ca_cert_name: ca.pem
    ca_host: bombadil
    packages: [ buildah, vault, qemu-guest-agent ]
    new_ca: true
  roles:
    # Make this machine it's own CA
    - role: certificate-authority-create
    - role: certificate-authority-copy-to-host
    # Install vault package
    - role: apt-add-source-vault
    - role: apt-update-all
    - role: apt-add-packages
    # Generate TLS certificates for Vault
    - role: certificate-authority-generate-certs
      vars:
        server_key_path: /opt/vault/tls/vault.key
        server_cert_path: /opt/vault/tls/vault.crt
        owner: vault
        group: vault
        mode: '0600'
    - role: vault-configure
    - role: vault-initialize
    # Install microk8s, including use of new CA
    - role: microk8s-install
    - role: microk8s-configure
    - role: python-deadsnakes-install
      vars:
        python_version: 3.13

- name: Setup Bombadil - Part 2 - (ubuntu stuff)
  hosts: bombadil
  tags: setup2
  become: no
  roles:
    - role: ghcr-secret-create
    # Configure Vault for KubeVault
    - role: vault-configure-for-kubevault
      vars:
        kubeapiaddress: https://192.168.86.7:16443
        vault_address: https://127.0.0.1:8200
        role: demo
        policy: my-app-policy
        transit_key: aes256-key
    - role: git-global-configure
    - role: git-clone-repositories
      vars:
        repositories:
          - name: secretmanager      
            repo: 'https://github.com/dekeyrej/secretmanager.git'
          - name: microservicematrix
            repo: 'https://github.com/dekeyrej/microservicematrix.git'
          - name: apiserver
            repo: 'https://github.com/dekeyrej/apiserver.git'
          - name: kv-updater
            repo: 'https://github.com/dekeyrej/kv-updater.git'
    - role: kubernetes-redis-deploy

- name: leftover setup server_cert_path
  hosts: bombadil
  tags: setup3
  become: no
  roles:
    - role: kubernetes-encryptonator-build
    - role: kubernetes-secrets-bootstrap 