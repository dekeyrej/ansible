# the-creation-of-manwe.yaml
# Provisions a Proxmox container and installs VS Code Server dependencies, CLI tools, and Git config,
# and fetches GitHub repositories

- name: create Proxmox Container (Manwë)
  hosts: localhost   # run from Ilúvatar
  vars:
    host_group: valar
    rootsize: 50
  roles:
    - role: proxmox-container-fetch-image
    - role: proxmox-container-create-cloud-init
  tasks:
    - name: Remove stale SSH keys
      ansible.builtin.shell: ssh-keygen -R {{ item }}
      loop: "{{ groups[host_group] }}"
      
    - name: Remove stale SSH keys
      ansible.builtin.shell: ssh-keygen -R {{ hostvars[item].ansible_host | default('') }}
      loop: "{{ groups[host_group] }}"

# wait for the container to settle...
- name: Wait for Container to become reachable
  hosts: manwe
  gather_facts: no
  tasks:
    - name: Wait for SSH to come up
      ansible.builtin.wait_for_connection:
        timeout: 300  # Adjust as needed
        delay: 0     # Initial delay before polling
        sleep: 5      # Time between retries
      
- name: Setup Code Server - Part 1 - Update and Install
  hosts: manwe
  become: yes
  roles:
    - role: apt-nodejs-add-source
    - role: apt-vault-add-source
    - role: apt-update-all
    - role: apt-add-packages
      vars:
        packages: [ansible, build-essential, curl, git, git-filter-repo, gpg, tree, unzip, wget, 
                  python3-proxmoxer, python3-kubernetes, python3-pip, python3-venv, pipx,
                  nodejs, vault]
    - role: kubernetes-kubectl-install

- name: Setup Code Server - Part 2 - create ssh keys and git config
  hosts: manwe
  become: no
  roles:
    - role: host-ssh-keys-set
    - role: git-global-configure
    - role: git-clone-repositories