- name: Microk8s Configure
  hosts: prime
  become: no
  tasks:

  - name: copy cluster recipe
    ansible.builtin.copy:
      src: /home/ubuntu/cluster_recipe
      dest: /home/ubuntu/cluster_recipe

  - name: dashboard ingress
    ansible.builtin.shell: 
      cmd: kubectl apply -f dashboard/ingress.yaml
      chdir: /home/ubuntu/cluster_recipe/

  # kubegres/postgres cluster
  - name: provision kubegres cluster
    ansible.builtin.shell:
      cmd: < 
        kubectl apply -f https://raw.githubusercontent.com/reactive-tech/kubegres/v1.19/kubegres.yaml
        kubectl apply -f kubegres/my-postgres-secret.yaml
        kubectl apply -f kubegres/my-postgres.yaml
        kubectl apply -f kubegres/my-postgres-services.yaml
      chdir: /home/ubuntu/cluster_recipe/

  - name: provision redis
    ansible.builtin.shell:
      cmd: < 
        kubectl apply -f redis/redis-config.yaml
        kubectl apply -f redis/redis-statefulset.yaml
        kubectl apply -f redis/redis-service.yaml
      chdir: /home/ubuntu/cluster_recipe/