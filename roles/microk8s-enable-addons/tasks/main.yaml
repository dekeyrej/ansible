# microk8s addons
- name: enable addons
  ansible.builtin.include_tasks: addon.yaml
  loop: "{{ addons }}"
  loop_control:
    label: "{{ item.name }}"

- name: sub-block for ceph
  block:
  - name: connect microk8s to microceph
    ansible.builtin.shell: sudo -E microk8s connect-external-ceph
  - ansible.builtin.pause: seconds=10

  # kubectl patch storageClass ceph-rbd -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
  - name: make ceph-rbd the default storage class
    ansible.builtin.command: 
      argv:
        - kubectl 
        - patch 
        - storageClass 
        - ceph-rbd 
        - -p
        - '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
  - ansible.builtin.pause: seconds=5

  
  # - name: enable minio  # this enables the microk8s-hostpath storageclass as default!?!
  #   ansible.builtin.shell: sudo -E microk8s enable minio -s ceph-rbd
  # - ansible.builtin.pause: seconds=5

  # - name: undefault microk8s-hostpath storageClass
  #   ansible.builtin.command: 
  #     argv:
  #       - kubectl 
  #       - patch 
  #       - storageclass 
  #       - microk8s-hostpath 
  #       - -p 
  #       - '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"false"}}}'

  when: ceph_enabled
# end ceph block

- name: create dashboard ingress
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        annotations:
          nginx.ingress.kubernetes.io/rewrite-target: /$2
          nginx.ingress.kubernetes.io/configuration-snippet: |
            rewrite ^(/dashboard)$ $1/ redirect;
          nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          kubernetes.io/ingress.class: public
        name: dashboard
        namespace: kube-system
      spec:
        rules:
        - http:
            paths:
            - path: /dashboard(/|$)(.*)
              pathType: Prefix
              backend:
                service:
                  name: kubernetes-dashboard
                  port:
                    number: 443

- name: save dashboard token
  ansible.builtin.shell: kubectl describe secret -n kube-system microk8s-dashboard-token | grep token > /home/ubuntu/dashboard.token
